"""
	Malware dataset builder
"""

import time
from requests import get
from bs4 import BeautifulSoup

from threading import Thread

url_backdoor = 'https://malshare.com/search.php?query=backdoor'
url_trojan = 'https://malshare.com/search.php?query=trojan'
url_rootkit = 'https://malshare.com/search.php?query=rootkit'
url_root = 'https://malshare.com/'
key = #insert your API key.

urls = {
    'backdoor': url_backdoor,
    'trojan': url_trojan,
    'rootkit': url_rootkit
} 

folders = {
    'backdoor': 'dataset/malwares/backdoor',
    'trojan': 'dataset/malwares/trojan',
    'rootkit': 'dataset/malwares/rootkit'
}

range_dict = {
    'backdoor': 0,
    'trojan': 0,
    'rootkit': 0
}

def download_data(name, url):
    print(name, url)
    response = get(url)
    html_soup = BeautifulSoup(response.text, 'html.parser')

    hash_container = html_soup.find_all('td', class_ = 'hash_font')
    print(type(hash_container))
    print(len(hash_container))

    for i in range(range_dict[name], len(hash_container)):
        print(name, i)
        path = f'{folders[name]}/{name}_{hash_container[i].string}.bin'  
        print(path)
        api = '/api.php?api_key={}&action=getfile&hash={}'.format(key, hash_container[i].string)
        r = get(url_root+api)
        print(open(path, 'wb').write(r.content))


thread_backdoor = Thread(target=download_data, args=('backdoor', urls['backdoor']))
thread_backdoor.start()

thread_rootkit = Thread(target=download_data, args=('rootkit', urls['rootkit']))
thread_rootkit.start()

thread_trojan = Thread(target=download_data, args=('trojan', urls['trojan']))
thread_trojan.start()

while(1):
    time.sleep(0.1)
